{"version":3,"sources":["js/helper/CSS3DRenderer.js"],"names":["THREE","CSS3DObject","element","Object3D","call","style","position","addEventListener","parentNode","removeChild","prototype","Object","create","constructor","CSS3DSprite","CSS3DRenderer","_width","_height","_widthHalf","_heightHalf","matrix","Matrix4","cache","camera","fov","objects","WeakMap","domElement","document","createElement","overflow","cameraElement","WebkitTransformStyle","transformStyle","appendChild","isIE","test","navigator","userAgent","getSize","width","height","setSize","epsilon","value","Math","abs","getCameraCSSMatrix","elements","getObjectCSSMatrix","cameraCSSMatrix","matrix3d","renderObject","object","copy","matrixWorldInverse","transpose","copyPosition","matrixWorld","scale","cachedObject","get","undefined","WebkitTransform","transform","objectData","distanceToCameraSquared","getDistanceToSquared","set","i","l","children","length","a","Vector3","b","object1","object2","setFromMatrixPosition","distanceToSquared","filterAndFlatten","scene","result","traverse","push","zOrder","sorted","sort","distanceA","distanceB","zMax","zIndex","render","projectionMatrix","isPerspectiveCamera","WebkitPerspective","perspective","updateMatrixWorld","parent","isOrthographicCamera","tx","right","left","ty","top","bottom"],"mappings":"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","file":"CSS3DRenderer.e26ffcee.js","sourceRoot":"..","sourcesContent":["/**\r\n * Based on http://www.emagix.net/academic/mscs-project/item/camera-sync-with-css3-and-webgl-threejs\r\n * @author mrdoob / http://mrdoob.com/\r\n * @author yomotsu / https://yomotsu.net/\r\n */\r\n\r\nTHREE.CSS3DObject = function (element) {\r\n\r\n\tTHREE.Object3D.call(this);\r\n\r\n\tthis.element = element;\r\n\tthis.element.style.position = 'absolute';\r\n\r\n\tthis.addEventListener('removed', function () {\r\n\r\n\t\tif (this.element.parentNode !== null) {\r\n\r\n\t\t\tthis.element.parentNode.removeChild(this.element);\r\n\r\n\t\t}\r\n\r\n\t});\r\n\r\n};\r\n\r\nTHREE.CSS3DObject.prototype = Object.create(THREE.Object3D.prototype);\r\nTHREE.CSS3DObject.prototype.constructor = THREE.CSS3DObject;\r\n\r\nTHREE.CSS3DSprite = function (element) {\r\n\r\n\tTHREE.CSS3DObject.call(this, element);\r\n\r\n};\r\n\r\nTHREE.CSS3DSprite.prototype = Object.create(THREE.CSS3DObject.prototype);\r\nTHREE.CSS3DSprite.prototype.constructor = THREE.CSS3DSprite;\r\n\r\n//\r\n\r\nTHREE.CSS3DRenderer = function () {\r\n\r\n\t// console.log( 'THREE.CSS3DRenderer', THREE.REVISION );\r\n\r\n\tvar _width, _height;\r\n\tvar _widthHalf, _heightHalf;\r\n\r\n\tvar matrix = new THREE.Matrix4();\r\n\r\n\tvar cache = {\r\n\t\tcamera: { fov: 0, style: '' },\r\n\t\tobjects: new WeakMap()\r\n\t};\r\n\r\n\tvar domElement = document.createElement('div');\r\n\tdomElement.style.overflow = 'hidden';\r\n\r\n\tthis.domElement = domElement;\r\n\r\n\tvar cameraElement = document.createElement('div');\r\n\r\n\tcameraElement.style.WebkitTransformStyle = 'preserve-3d';\r\n\tcameraElement.style.transformStyle = 'preserve-3d';\r\n\r\n\tdomElement.appendChild(cameraElement);\r\n\r\n\tvar isIE = /Trident/i.test(navigator.userAgent);\r\n\r\n\tthis.getSize = function () {\r\n\r\n\t\treturn {\r\n\t\t\twidth: _width,\r\n\t\t\theight: _height\r\n\t\t};\r\n\r\n\t};\r\n\r\n\tthis.setSize = function (width, height) {\r\n\r\n\t\t_width = width;\r\n\t\t_height = height;\r\n\t\t_widthHalf = _width / 2;\r\n\t\t_heightHalf = _height / 2;\r\n\r\n\t\tdomElement.style.width = width + 'px';\r\n\t\tdomElement.style.height = height + 'px';\r\n\r\n\t\tcameraElement.style.width = width + 'px';\r\n\t\tcameraElement.style.height = height + 'px';\r\n\r\n\t};\r\n\r\n\tfunction epsilon(value) {\r\n\r\n\t\treturn Math.abs(value) < 1e-10 ? 0 : value;\r\n\r\n\t}\r\n\r\n\tfunction getCameraCSSMatrix(matrix) {\r\n\r\n\t\tvar elements = matrix.elements;\r\n\r\n\t\treturn 'matrix3d(' +\r\n\t\t\tepsilon(elements[0]) + ',' +\r\n\t\t\tepsilon(- elements[1]) + ',' +\r\n\t\t\tepsilon(elements[2]) + ',' +\r\n\t\t\tepsilon(elements[3]) + ',' +\r\n\t\t\tepsilon(elements[4]) + ',' +\r\n\t\t\tepsilon(- elements[5]) + ',' +\r\n\t\t\tepsilon(elements[6]) + ',' +\r\n\t\t\tepsilon(elements[7]) + ',' +\r\n\t\t\tepsilon(elements[8]) + ',' +\r\n\t\t\tepsilon(- elements[9]) + ',' +\r\n\t\t\tepsilon(elements[10]) + ',' +\r\n\t\t\tepsilon(elements[11]) + ',' +\r\n\t\t\tepsilon(elements[12]) + ',' +\r\n\t\t\tepsilon(- elements[13]) + ',' +\r\n\t\t\tepsilon(elements[14]) + ',' +\r\n\t\t\tepsilon(elements[15]) +\r\n\t\t\t')';\r\n\r\n\t}\r\n\r\n\tfunction getObjectCSSMatrix(matrix, cameraCSSMatrix) {\r\n\r\n\t\tvar elements = matrix.elements;\r\n\t\tvar matrix3d = 'matrix3d(' +\r\n\t\t\tepsilon(elements[0]) + ',' +\r\n\t\t\tepsilon(elements[1]) + ',' +\r\n\t\t\tepsilon(elements[2]) + ',' +\r\n\t\t\tepsilon(elements[3]) + ',' +\r\n\t\t\tepsilon(- elements[4]) + ',' +\r\n\t\t\tepsilon(- elements[5]) + ',' +\r\n\t\t\tepsilon(- elements[6]) + ',' +\r\n\t\t\tepsilon(- elements[7]) + ',' +\r\n\t\t\tepsilon(elements[8]) + ',' +\r\n\t\t\tepsilon(elements[9]) + ',' +\r\n\t\t\tepsilon(elements[10]) + ',' +\r\n\t\t\tepsilon(elements[11]) + ',' +\r\n\t\t\tepsilon(elements[12]) + ',' +\r\n\t\t\tepsilon(elements[13]) + ',' +\r\n\t\t\tepsilon(elements[14]) + ',' +\r\n\t\t\tepsilon(elements[15]) +\r\n\t\t\t')';\r\n\r\n\t\tif (isIE) {\r\n\r\n\t\t\treturn 'translate(-50%,-50%)' +\r\n\t\t\t\t'translate(' + _widthHalf + 'px,' + _heightHalf + 'px)' +\r\n\t\t\t\tcameraCSSMatrix +\r\n\t\t\t\tmatrix3d;\r\n\r\n\t\t}\r\n\r\n\t\treturn 'translate(-50%,-50%)' + matrix3d;\r\n\r\n\t}\r\n\r\n\tfunction renderObject(object, camera, cameraCSSMatrix) {\r\n\r\n\t\tif (object instanceof THREE.CSS3DObject) {\r\n\r\n\t\t\tvar style;\r\n\r\n\t\t\tif (object instanceof THREE.CSS3DSprite) {\r\n\r\n\t\t\t\t// http://swiftcoder.wordpress.com/2008/11/25/constructing-a-billboard-matrix/\r\n\r\n\t\t\t\tmatrix.copy(camera.matrixWorldInverse);\r\n\t\t\t\tmatrix.transpose();\r\n\t\t\t\tmatrix.copyPosition(object.matrixWorld);\r\n\t\t\t\tmatrix.scale(object.scale);\r\n\r\n\t\t\t\tmatrix.elements[3] = 0;\r\n\t\t\t\tmatrix.elements[7] = 0;\r\n\t\t\t\tmatrix.elements[11] = 0;\r\n\t\t\t\tmatrix.elements[15] = 1;\r\n\r\n\t\t\t\tstyle = getObjectCSSMatrix(matrix, cameraCSSMatrix);\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\tstyle = getObjectCSSMatrix(object.matrixWorld, cameraCSSMatrix);\r\n\r\n\t\t\t}\r\n\r\n\t\t\tvar element = object.element;\r\n\t\t\tvar cachedObject = cache.objects.get(object);\r\n\r\n\t\t\tif (cachedObject === undefined || cachedObject.style !== style) {\r\n\r\n\t\t\t\telement.style.WebkitTransform = style;\r\n\t\t\t\telement.style.transform = style;\r\n\r\n\t\t\t\tvar objectData = { style: style };\r\n\r\n\t\t\t\tif (isIE) {\r\n\r\n\t\t\t\t\tobjectData.distanceToCameraSquared = getDistanceToSquared(camera, object);\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tcache.objects.set(object, objectData);\r\n\r\n\t\t\t}\r\n\r\n\t\t\tif (element.parentNode !== cameraElement) {\r\n\r\n\t\t\t\tcameraElement.appendChild(element);\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\tfor (var i = 0, l = object.children.length; i < l; i++) {\r\n\r\n\t\t\trenderObject(object.children[i], camera, cameraCSSMatrix);\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\tvar getDistanceToSquared = function () {\r\n\r\n\t\tvar a = new THREE.Vector3();\r\n\t\tvar b = new THREE.Vector3();\r\n\r\n\t\treturn function (object1, object2) {\r\n\r\n\t\t\ta.setFromMatrixPosition(object1.matrixWorld);\r\n\t\t\tb.setFromMatrixPosition(object2.matrixWorld);\r\n\r\n\t\t\treturn a.distanceToSquared(b);\r\n\r\n\t\t};\r\n\r\n\t}();\r\n\r\n\tfunction filterAndFlatten(scene) {\r\n\r\n\t\tvar result = [];\r\n\r\n\t\tscene.traverse(function (object) {\r\n\r\n\t\t\tif (object instanceof THREE.CSS3DObject) result.push(object);\r\n\r\n\t\t});\r\n\r\n\t\treturn result;\r\n\r\n\t}\r\n\r\n\tfunction zOrder(scene) {\r\n\r\n\t\tvar sorted = filterAndFlatten(scene).sort(function (a, b) {\r\n\r\n\t\t\tvar distanceA = cache.objects.get(a).distanceToCameraSquared;\r\n\t\t\tvar distanceB = cache.objects.get(b).distanceToCameraSquared;\r\n\r\n\t\t\treturn distanceA - distanceB;\r\n\r\n\t\t});\r\n\r\n\t\tvar zMax = sorted.length;\r\n\r\n\t\tfor (var i = 0, l = sorted.length; i < l; i++) {\r\n\r\n\t\t\tsorted[i].element.style.zIndex = zMax - i;\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\tthis.render = function (scene, camera) {\r\n\r\n\t\tvar fov = camera.projectionMatrix.elements[5] * _heightHalf;\r\n\r\n\t\tif (cache.camera.fov !== fov) {\r\n\r\n\t\t\tif (camera.isPerspectiveCamera) {\r\n\r\n\t\t\t\tdomElement.style.WebkitPerspective = fov + 'px';\r\n\t\t\t\tdomElement.style.perspective = fov + 'px';\r\n\r\n\t\t\t}\r\n\r\n\t\t\tcache.camera.fov = fov;\r\n\r\n\t\t}\r\n\r\n\t\tscene.updateMatrixWorld();\r\n\r\n\t\tif (camera.parent === null) camera.updateMatrixWorld();\r\n\r\n\t\tif (camera.isOrthographicCamera) {\r\n\r\n\t\t\tvar tx = - (camera.right + camera.left) / 2;\r\n\t\t\tvar ty = (camera.top + camera.bottom) / 2;\r\n\r\n\t\t}\r\n\r\n\t\tvar cameraCSSMatrix = camera.isOrthographicCamera ?\r\n\t\t\t'scale(' + fov + ')' + 'translate(' + epsilon(tx) + 'px,' + epsilon(ty) + 'px)' + getCameraCSSMatrix(camera.matrixWorldInverse) :\r\n\t\t\t'translateZ(' + fov + 'px)' + getCameraCSSMatrix(camera.matrixWorldInverse);\r\n\r\n\t\tvar style = cameraCSSMatrix +\r\n\t\t\t'translate(' + _widthHalf + 'px,' + _heightHalf + 'px)';\r\n\r\n\t\tif (cache.camera.style !== style && !isIE) {\r\n\r\n\t\t\tcameraElement.style.WebkitTransform = style;\r\n\t\t\tcameraElement.style.transform = style;\r\n\r\n\t\t\tcache.camera.style = style;\r\n\r\n\t\t}\r\n\r\n\t\trenderObject(scene, camera, cameraCSSMatrix);\r\n\r\n\t\tif (isIE) {\r\n\r\n\t\t\t// IE10 and 11 does not support 'preserve-3d'.\r\n\t\t\t// Thus, z-order in 3D will not work.\r\n\t\t\t// We have to calc z-order manually and set CSS z-index for IE.\r\n\t\t\t// FYI: z-index can't handle object intersection\r\n\t\t\tzOrder(scene);\r\n\r\n\t\t}\r\n\r\n\t};\r\n\r\n};\r\n"]}